#!/usr/bin/env bash
# -*- bash -*-
#
#!/usr/bin/env node
# -*- js   -*-
#
#!/usr/bin/env lua
# -*- js   -*-
#
cmd=$1
set -u -e -o pipefail



lua_rocks=conf/lua_rocks
deploy_rocks=conf/lua_rocks.deploy
install_rock="luarocks install --tree=.rocks"

function read_rocks() {
  rocks=$(cat conf/lua_rocks)
}

function remove_rocks() {
  if [[ -d .rocks ]]
  then
    trash-put .rocks
  fi
}

function install_all() {
  read_rocks
  for rock in $rocks
  do
     $install_rock $rock
  done
}


function install_config_file() {
config_content="
rocks_servers = {
   [[http://luarocks.org/repositories/rocks]],
   [[http://rocks.moonscript.org]],
   [[https://raw.github.com/da99/rocks/master/rocks]]
}

rocks_trees = {
   [[/usr/local]],
   [[.rocks]]
}
"
  config=/etc/luarocks/config.lua
  if [[ ! -f $config.backup ]]
  then
    sudo cp $config $config.backup
  fi

  echo "$config_content" > /tmp/lua.config
  sudo mv -f /tmp/lua.config $config
}

function push_rock () {
  git push
  cp rockspec /apps/rocks/rocks/$(lrm rockspec filename)
  luarocks make --pack-binary-rock

  mv *.rock /apps/rocks/rocks

  cd /apps/rocks
  luarocks-admin make-manifest rocks

  git add rocks/*
  if [[ ! -z "$(git status --porcelain)" ]]
  then
    git commit -m "Added: new rockspecs"
    git push origin master
  fi
}

function init() {
  mkdir -p conf
  if [[ ! -f $lua_rocks ]]
  then
    echo penlight   >> $lua_rocks
    echo underscore >> $lua_rocks
  fi

  touch .gitignore
  if ! grep --quiet "^.rocks$" .gitignore
  then
    echo ".rocks" >> .gitignore
  fi
}

case "$1" in

  # === Installing lua rocks... ===========================================

  list)
    read_rocks
    echo "$rocks"
    ;;

  install)
    shift
    luarocks --tree=.rocks install "$@"
    ;;

  update_all)
    remove_rocks
    install_all
    ;;

  install_config_file) install_config_file
    ;;

  init) init
    ;;

  # === Deploying an app... ===============================================

  generate_deploy)
    lrm list_installed > $deploy_rocks
    cat $deploy_rocks
    ;;

  install_deploy)
    rocks="$(cat $deploy_rocks)"
    cat $deploy_rocks | while read line; do
      echo -e "Installing: $line\n"
      $install_rock $line
    done
    ;;

  list_installed)
    dir=.rocks/lib/luarocks/rocks
    cur=$(pwd)
    cd $dir
    for r in *
    do
      rock=$cur/$dir/$r
      if [[ -d $rock ]]
      then
        cd $rock
        for v in *
        do
          echo $r $v
        done
      fi
    done
    ;;

  # === Publishing a lua app... ===========================================

  version) lua -e  "dofile('rockspec'); print(version)"
    ;;

  push_rock) push_rock
    ;;

  rockspec)
    case "$2" in
      filename)
        lua -e  "dofile('rockspec'); print(package .. '-' .. version .. '.rockspec')"
        ;;
      *) echo "unknown command for rockspec: $2"
        exit 1
        ;;
    esac
    ;;

  bump)
    if [[ ! -z "$(git status --porcelain)" ]]
    then
      echo "Git repo not clean enough."
      exit 1
    fi
    cmd=$2
    old=$(lrm version)
    new=$(bump_lua_rock_ver $(lrm version) $cmd)

    sed -i -e "s/\([^0-9]\)$old\([^0-9]\)/\1$new\2/g" rockspec
    git add rockspec
    git commit -m "$new (bumped $cmd)"
    git tag "v$new"
    echo "$new"
    ;;

  *) echo "Unknown command: $@"
    exit 1
    ;;

esac


